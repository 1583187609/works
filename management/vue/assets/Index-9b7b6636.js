var e,t;import{M as a,ak as s,c5 as o,c6 as n,c7 as l,c8 as i,c9 as r,aM as u,aK as c,b_ as p,q as d,bs as m,ca as g,cb as _,cc as f,c4 as v,cd as h,u as y,I as b,bx as B,am as j,bc as x,af as z,aQ as A,s as S,t as w,ce as P,cf as F,cg as $,aa as C,aE as O,ap as R,a3 as M,bH as q}from"./index-3bafcaf7.js";import{_ as D}from"./Index.vue_vue_type_script_setup_true_lang-2c50a214.js";import L from"./QueryTable-57374669.js";import k from"./Index-67c2b220.js";import{g as V}from"./index-51f0779e.js";import{_ as E}from"./Pagination.vue_vue_type_script_setup_true_lang-a38de151.js";import{g as I,h as Q,b as U}from"./_utils-bf80188b.js";import"./SetTable.vue_vue_type_script_setup_true_lang-2fe3872c.js";import"./BaseTable-9c683f18.js";import"./Column.vue_vue_type_script_name_Column_setup_true_lang-1b6e2596.js";import"./GroupBtns-7a6a694b.js";import"./cascader-4ea16d0d.js";import"./BaseRender.vue_vue_type_script_setup_true_lang-c7121409.js";import"./_utils-f77ebb4c.js";import"./_config-0a862e30.js";import"./SetPrint-0b3b4a9b.js";import"./BatchBtns.vue_vue_type_script_setup_true_lang-f1cd91b8.js";import"./QueryFields-02b1cc27.js";import"./QueryBtns.vue_vue_type_style_index_0_lang-9f185e87.js";import"./_utils-89ec2a56.js";import"./_config-c0994392.js";const K=q(a({__name:"Index",props:s({modelValue:{},rowKey:{},formAttrs:{},tableAttrs:{},pageAttrs:{},disabled:{type:Boolean},groupBtnsAttrs:{},pagination:{type:[Boolean,Object]},fields:{},sections:{},cols:{},selectAll:{type:Boolean},fetch:{},fetchSuccess:{type:Function},fetchFail:{type:Function},immediate:{type:Boolean},extraBtns:{},groupBtns:{type:[Array,Function]},reqMap:{},resMap:{},showPagination:{type:Boolean},summaryList:{type:[Boolean,Function]},sort:{type:Boolean},index:{type:Boolean},selection:{type:Boolean},batchBtn:{type:Boolean},exportLimit:{},extraParams:{},log:{type:Boolean},debug:{type:Boolean},isOmit:{type:Boolean},changeFetch:{type:Boolean},inputDebounce:{type:Boolean},filterByAuth:{type:Function},colSpanAttrs:{},compact:{type:Boolean},size:{},rowNum:{},handleReq:{type:Function},handleRes:{type:Function}},Object.assign({rowKey:"id",log:!o,fields:()=>[],cols:()=>[],immediate:!0,changeFetch:!0,batchBtn:!1,isOmit:!0,inputDebounce:!0,exportLimit:1e4,pagination:()=>({currPage:1,pageSize:20}),reqMap:n,resMap:l,showPagination:!0,colSpanAttrs:i,compact:e=>e.colSpanAttrs.xl<6,filterByAuth:e=>!0},null==(t=null==(e=r)?void 0:e.BaseCrud)?void 0:t.Index)),emits:["update:modelValue","extraBtn","groupBtn","selectionChange","rows"],setup(e,{expose:t,emit:a}){const s=u([]),o=e,n=a,l=C("closePopup"),i=u(null),r=u(null),q=u(null),K=u(null),{reqMap:T,resMap:N,extraParams:G={}}=o,W=o.pagination?{[`${T.curr_page}`]:o.pagination.currPage,[`${T.page_size}`]:o.pagination.pageSize}:{},Y={...W,...G},H=c(p.cloneDeep(W)),X=c({total:0,hasMore:!0}),Z=u(!1),J=u([]),ee=u([]);let te=d({get:()=>o.modelValue,set(e){n("update:modelValue",e)}}),ae=p.cloneDeep(Y);const se=d((()=>{const{extraBtns:e,disabled:t}=o;return fe((null==e?void 0:e.map((e=>{var a;const s=V(e),{name:o,attrs:n,customRules:l}=s;return(null==(a=U)?void 0:a.includes(o))&&(s.popconfirm=!1,n.disabled=l?!X.total:!ee.value.length),t&&(n.disabled=t),s})))||[])})),oe=d((()=>!!se.value.find((e=>U.includes(e.name)&&!e.customRules)))),ne=d((()=>o.selection||oe.value)),le=u(o.cols.slice());function ie(){Object.assign(H,W),ae=p.cloneDeep(Y),de(ae,void 0,"reset")}function re(e){Object.assign(ae,{[`${T.curr_page}`]:1}),de(ae,void 0,"search")}function ue(e){Object.assign(ae,{[`${T.curr_page}`]:1,[`${T.page_size}`]:e}),de(ae,void 0,"sizeChange")}function ce(e){Object.assign(ae,{[`${T.curr_page}`]:e}),de(ae,void 0,"currChange")}function pe(e,t){const{immediate:a,changeFetch:s}=o;if(e=P(e),t)p.merge(ae,e),Object.assign(Y,ae);else{if(!s)return;Object.assign(ae,e,{[`${T.curr_page}`]:1})}a&&de(ae,void 0,"change")}function de(e=ae,t,a="expose"){const{fetch:s,handleReq:l,isOmit:i,handleRes:r,selectAll:u,summaryList:c,fetchSuccess:p,fetchFail:d,log:m}=o;s&&(Z.value=!0,l&&(e=l(e)),i&&(e=g(e)),m&&F(e,"req"),s(e).then((a=>{if(!a)return;r&&(a=r(a));let s=a[N.records];if(!s)return;m&&F(s,"res");const o=e[T.curr_page];if(c){const e=v(c),t=J.value;if("Boolean"===e)J.value=1===o?s:[...t,...s];else{if("Function"!==e)throw new Error(`暂未处理此种类型：${e}`);J.value=c(o,t,s)}}else J.value=s;Object.assign(X,{total:a[N.total_num],hasMore:a[N.has_more]}),Object.assign(H,{[T.curr_page]:o,[T.page_size]:e[T.page_size]}),u&&(ee.value=s),null==p||p(a),n("rows",J.value,e),null==t||t()})).catch((e=>{null==d||d(e)})).finally((()=>{Z.value=!1})))}function me(e){const{rowKey:t,exportLimit:a}=o,{text:r}=e;Q({btnObj:e,cols:s.value,seledRows:ee.value,seledKeys:ee.value.map((e=>e[t])),total:X.total,exportLimit:a,emits:n,next:(e=`${r||"操作"}成功`,t,a,s=!0)=>{$(e),l(t),s&&ve(),ne.value&&i.value.clearSelection(),null==a||a()}})}function ge(e,t,a,s=!0){const{name:o,text:l}=e;n("groupBtn",o,t,((e,t,o)=>{a(e,t,o),s&&ve()}))}function _e(e,t){ee.value=e,n("selectionChange",e,t)}function fe(e=[]){const{filterByAuth:t}=o;return t?e.filter((({auth:e})=>!(null==e?void 0:e.length)||t(e))):e}function ve(e){de(ae,e,"refresh")}return m((()=>o.extraParams),(e=>{p.merge(ae,e),de(ae,void 0,"extraParams")}),{deep:!0}),t({refreshList:ve,getList:de,getQueryParams:(e=o.isOmit)=>e?g(ae):ae,getQueryFields(e=[T.curr_page,T.page_size]){const t=[],a=[],s=r.value.getFields();s.forEach((e=>{var t;(null==(t=e.prop)?void 0:t.includes(_))&&a.push(e.prop)}));for(const o in ae)if(e&&!e.includes(o)){const e=s.find((e=>e.prop===o));if(e){const a=ae[o];!f.includes(a)&&("Array"!==v(a)||a.some((e=>""!==e)))&&t.push({label:e.label,value:I(e,a)})}}return a.forEach((e=>{const[a,o]=e.split(_),n=ae[a],l=ae[o],i=s.find((t=>t.prop.includes(e)));i&&(n||l)&&t.push({label:i.label,value:[n,l].join(h)})})),t}}),(e,t)=>{var a;return O(),y("div",{class:"base-crud f-fs-s-c",ref_key:"baseCrudRef",ref:K},[b(k,j({class:["f-0","small"===e.size?"mb-6":"mb-h"],modelValue:x(te),"onUpdate:modelValue":t[0]||(t[0]=e=>z(te)?te.value=e:te=e),disabled:e.disabled,fields:e.fields,sections:e.sections,loading:Z.value,inputDebounce:e.inputDebounce,colSpanAttrs:e.colSpanAttrs,compact:e.compact,onReset:ie,onSearch:re,onChange:pe,size:e.size,rowNum:e.rowNum},e.formAttrs,{ref_key:"queryFormRef",ref:r}),{custom:B((({field:t,form:a})=>[A(e.$slots,t.prop,{field:t,form:a},void 0,!0)])),_:3},16,["class","modelValue","disabled","fields","sections","loading","inputDebounce","colSpanAttrs","compact","size","rowNum"]),A(e.$slots,"middle",{},void 0,!0),se.value.length?(O(),S(D,{key:0,class:"f-0",columns:le.value,allColumns:s.value,btns:se.value,isEmpty:!(null==(a=J.value)?void 0:a.length),"onUpdate:cols":t[1]||(t[1]=e=>{le.value=e}),onClick:me,total:X.total,batchBtn:e.batchBtn&&e.selection,size:e.size,ref_key:"extraBtnsRef",ref:q},null,8,["columns","allColumns","btns","isEmpty","total","batchBtn","size"])):w("",!0),A(e.$slots,"default",{loading:Z.value,rows:J.value,total:X.total,hasMore:X.hasMore,params:x(ae),onGroupBtn:ge},(()=>[b(L,j({groupBtnsAttrs:{compact:e.compact,small:"small"===e.size,...e.groupBtnsAttrs},loading:Z.value,cols:le.value,rows:J.value,total:X.total,sort:e.sort,index:e.index,selection:ne.value,groupBtns:e.groupBtns,currPage:e.pagination?H[x(T).curr_page]:1,pageSize:e.pagination?H[x(T).page_size]:20,filterBtnsByAuth:fe,refreshList:ve,onGroupBtn:ge,onSelectionChange:_e,"onUpdate:cols":t[2]||(t[2]=e=>{s.value=e}),disabled:e.disabled},e.tableAttrs,{size:e.size,ref_key:"queryTableRef",ref:i}),{custom:B((({row:t,col:a,$index:s})=>[A(e.$slots,a.prop,R(M({row:t,col:a,$index:s})),void 0,!0)])),_:3},16,["groupBtnsAttrs","loading","cols","rows","total","sort","index","selection","groupBtns","currPage","pageSize","disabled","size"])]),!0),e.pagination&&e.showPagination?(O(),S(E,j({key:1},e.pageAttrs,{currPage:H[x(T).curr_page],"onUpdate:currPage":t[3]||(t[3]=e=>H[x(T).curr_page]=e),pageSize:H[x(T).page_size],"onUpdate:pageSize":t[4]||(t[4]=e=>H[x(T).page_size]=e),total:X.total,onSizeChange:ue,onCurrentChange:ce,small:"small"===e.size}),null,16,["currPage","pageSize","total","small"])):w("",!0)],512)}}}),[["__scopeId","data-v-4d2cb6e0"]]);export{K as default};
