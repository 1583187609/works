var e,t;import{l as s}from"./lodash-8dc1f9dc.js";import{_ as o}from"./Index.vue_vue_type_script_setup_true_lang-b45e8bd0.js";import a from"./QueryTable-fd090177.js";import r from"./Index-6fca1b7b.js";import{g as n}from"./index-0a44dd7a.js";import"./dayjs-21617033.js";import{i,d as l,a as p,b as u,c,o as m,p as d,e as g,t as f,r as _,s as j,f as v,g as h,_ as y}from"./index-8cf28f90.js";import{_ as b}from"./Pagination.vue_vue_type_script_setup_true_lang-f1a5dc3e.js";import{g as B,h as x,b as z}from"./_utils-c39af746.js";import{S as w}from"./sortablejs-b0ad9b27.js";import{d as S,bd as A,e as P,_ as C,j as F,f as $,i as O,o as R,c as I,V as q,P as L,L as k,u as D,D as M,I as E,O as V,S as U,B as N,ac as Q,ad as G}from"./@vue-022d9836.js";import"./call-bind-ada3a9fc.js";import"./get-intrinsic-176af07e.js";import"./es-errors-c8ed318b.js";import"./has-symbols-456daba2.js";import"./has-proto-c2a23985.js";import"./function-bind-afbcd6f2.js";import"./hasown-c3b72c9b.js";import"./set-function-length-968dc075.js";import"./define-data-property-9d7bf764.js";import"./es-define-property-c2edbfb6.js";import"./gopd-16a4ddf0.js";import"./has-property-descriptors-52e43c9d.js";import"./@element-plus-91223246.js";import"./SetTable.vue_vue_type_script_setup_true_lang-9a925c97.js";import"./BaseTable-93468457.js";import"./Column.vue_vue_type_script_name_Column_setup_true_lang-92dec00d.js";import"./GroupBtns-dfbc2150.js";import"./vue-router-e17d6507.js";import"./UserInfo-6031a43f.js";import"./cascader-082fe68e.js";import"./BaseRender.vue_vue_type_script_setup_true_lang-100cb175.js";import"./element-plus-6dad9269.js";import"./lodash-es-d4f5f48c.js";import"./@vueuse-c70f8764.js";import"./@popperjs-b78c3215.js";import"./@ctrl-91de2ec7.js";import"./async-validator-cf877c1f.js";import"./memoize-one-63ab667a.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui-3c499e77.js";import"./_utils-e8eebd93.js";import"./_config-0a862e30.js";import"./SetPrint-879102cd.js";import"./BatchBtns.vue_vue_type_script_setup_true_lang-9753f0d8.js";import"./nprogress-b5e58671.js";import"./QueryFields-02bd1222.js";import"./QueryBtns.vue_vue_type_style_index_0_lang-4a69d20b.js";import"./_utils-f23ae63f.js";import"./_config-c0994392.js";import"./xlsx-c1bdd32b.js";import"./qs-fd29a741.js";import"./side-channel-5a41c40a.js";import"./object-inspect-0d550a97.js";import"./axios-86de682d.js";import"./pinia-f80f4126.js";import"./mock-ada1f893.js";import"./mockjs-217213d3.js";import"./vite-plugin-mock-6db8ade2.js";import"./path-to-regexp-83a43451.js";const K=y(S({name:"BaseCrud",__name:"Index",props:A({modelValue:{},rowKey:{},formAttrs:{},tableAttrs:{},pageAttrs:{},disabled:{type:Boolean},groupBtnsAttrs:{},pagination:{type:[Boolean,Object]},fields:{},sections:{},cols:{},selectAll:{type:Boolean},fetch:{},fetchSuccess:{type:Function},fetchFail:{type:Function},immediate:{type:Boolean},extraBtns:{},groupBtns:{type:[Array,Function]},reqMap:{},resMap:{},showPagination:{type:Boolean},summaryList:{type:[Boolean,Function]},sort:{type:Boolean},index:{type:Boolean},selection:{type:Boolean},batchBtn:{type:Boolean},exportLimit:{},extraParams:{},log:{type:Boolean},debug:{type:Boolean},isOmit:{type:Boolean},changeFetch:{type:Boolean},inputDebounce:{type:Boolean},filterByAuth:{type:Function},colSpanAttrs:{},compact:{type:Boolean},size:{},rowNum:{},handleReq:{type:Function},handleRes:{type:Function}},Object.assign({rowKey:"id",log:!i,fields:()=>[],cols:()=>[],immediate:!0,changeFetch:!0,batchBtn:!1,isOmit:!0,inputDebounce:!0,exportLimit:1e4,pagination:()=>({currPage:1,pageSize:20}),reqMap:l,resMap:p,showPagination:!0,colSpanAttrs:u,compact:e=>e.colSpanAttrs.xl<6,filterByAuth:e=>!0},null==(t=null==(e=c)?void 0:e.BaseCrud)?void 0:t.Index)),emits:["update:modelValue","extraBtn","groupBtn","selectionChange","rows","dargSortEnd"],setup(e,{expose:t,emit:i}){const l=P([]),p=e,u=i,c=N("closePopup"),y=P(null),S=P(null),A=P(null),K=P(null),{reqMap:T,resMap:J,extraParams:H={}}=p,W=p.pagination?{[`${T.curr_page}`]:p.pagination.currPage,[`${T.page_size}`]:p.pagination.pageSize}:{},X={...W,...H},Y=C(s.cloneDeep(W)),Z=C({total:0,hasMore:!0}),ee=P(!1),te=P([]),se=P([]);let oe=F({get:()=>p.modelValue,set(e){u("update:modelValue",e)}}),ae=s.cloneDeep(X);const re=F((()=>{const{extraBtns:e,disabled:t}=p;return ve((null==e?void 0:e.map((e=>{var s;const o=n(e),{name:a,attrs:r,customRules:i}=o;return(null==(s=z)?void 0:s.includes(a))&&(o.popconfirm=!1,r.disabled=i?!Z.total:!se.value.length),t&&(r.disabled=t),o})))||[])})),ne=F((()=>!!re.value.find((e=>z.includes(e.name)&&!e.customRules)))),ie=F((()=>p.selection||ne.value)),le=P(p.cols.slice());function pe(){Object.assign(Y,W),ae=s.cloneDeep(X),ge(ae,void 0,"reset")}function ue(e){Object.assign(ae,{[`${T.curr_page}`]:1}),ge(ae,void 0,"search")}function ce(e){Object.assign(ae,{[`${T.curr_page}`]:1,[`${T.page_size}`]:e}),ge(ae,void 0,"sizeChange")}function me(e){Object.assign(ae,{[`${T.curr_page}`]:e}),ge(ae,void 0,"currChange")}function de(e,t){const{immediate:o,changeFetch:a}=p;if(e=v(e),t)s.merge(ae,e),Object.assign(X,ae);else{if(!a)return;Object.assign(ae,e,{[`${T.curr_page}`]:1})}o&&ge(ae,void 0,"change")}function ge(e=ae,t,s="expose"){const{fetch:o,handleReq:a,isOmit:r,handleRes:n,selectAll:i,summaryList:l,fetchSuccess:c,fetchFail:d,log:g}=p;o&&(ee.value=!0,a&&(e=a(e)),r&&(e=m(e)),g&&h(e,"req"),o(e).then((s=>{if(!s)return;n&&(s=n(s));let o=s[J.records];if(!o)return;g&&h(o,"res");const a=e[T.curr_page];if(l){const e=f(l),t=te.value;if("Boolean"===e)te.value=1===a?o:[...t,...o];else{if("Function"!==e)throw new Error(`暂未处理此种类型：${e}`);te.value=l(a,t,o)}}else te.value=o;Object.assign(Z,{total:s[J.total_num],hasMore:s[J.has_more]}),Object.assign(Y,{[T.curr_page]:a,[T.page_size]:e[T.page_size]}),i&&(se.value=o),null==c||c(s),u("rows",te.value,e),null==t||t()})).catch((e=>{null==d||d(e)})).finally((()=>{ee.value=!1})))}function fe(e){const{rowKey:t,exportLimit:s}=p,{text:o}=e;x({btnObj:e,cols:l.value,seledRows:se.value,seledKeys:se.value.map((e=>e[t])),total:Z.total,exportLimit:s,emits:u,next:(e=`${o||"操作"}成功`,t,s,a=!0)=>{j(e),c(t),a&&he(),ie.value&&y.value.clearSelection(),null==s||s()}})}function _e(e,t,s,o=!0){const{name:a,text:r}=e;u("groupBtn",a,t,((e,t,a)=>{s(e,t,a),o&&he()}))}function je(e,t){se.value=e,u("selectionChange",e,t)}function ve(e=[]){const{filterByAuth:t}=p;return t?e.filter((({auth:e})=>!(null==e?void 0:e.length)||t(e))):e}function he(e){ge(ae,e,"refresh")}return $((()=>p.extraParams),(e=>{s.merge(ae,e),ge(ae,void 0,"extraParams")}),{deep:!0}),O((()=>{p.sort&&function(e=y.value.tableRef.$el.querySelector(".el-table__body-wrapper tbody")){w.create(e,{handle:".sort-cell",animation:300,onEnd(e){const{newIndex:t,oldIndex:s}=e;"boolean"==typeof p.sort&&u("dargSortEnd",{newIndex:t,oldIndex:s},((e="修改排序成功")=>{j(e)}))}})}()})),t({refreshList:he,getList:ge,getQueryParams:(e=p.isOmit)=>e?m(ae):ae,getQueryFields(e=[T.curr_page,T.page_size]){const t=[],s=[],o=S.value.getFields();o.forEach((e=>{var t;(null==(t=e.prop)?void 0:t.includes(d))&&s.push(e.prop)}));for(const a in ae)if(e&&!e.includes(a)){const e=o.find((e=>e.prop===a));if(e){const s=ae[a];!g.includes(s)&&("Array"!==f(s)||s.some((e=>""!==e)))&&t.push({label:e.label,value:B(e,s)})}}return s.forEach((e=>{const[s,a]=e.split(d),r=ae[s],n=ae[a],i=o.find((t=>t.prop.includes(e)));i&&(r||n)&&t.push({label:i.label,value:[r,n].join(_)})})),t}}),(e,t)=>{var s;return R(),I("div",{class:"base-crud f-fs-s-c",ref_key:"baseCrudRef",ref:K},[q(r,k({class:["f-0","small"===e.size?"mb-6":"mb-h"],modelValue:D(oe),"onUpdate:modelValue":t[0]||(t[0]=e=>M(oe)?oe.value=e:oe=e),disabled:e.disabled,fields:e.fields,sections:e.sections,loading:ee.value,inputDebounce:e.inputDebounce,colSpanAttrs:e.colSpanAttrs,compact:e.compact,onReset:pe,onSearch:ue,onChange:de,size:e.size,rowNum:e.rowNum},e.formAttrs,{ref_key:"queryFormRef",ref:S}),{custom:L((({field:t,form:s})=>[E(e.$slots,t.prop,{field:t,form:s},void 0,!0)])),_:3},16,["class","modelValue","disabled","fields","sections","loading","inputDebounce","colSpanAttrs","compact","size","rowNum"]),E(e.$slots,"middle",{},void 0,!0),re.value.length?(R(),V(o,{key:0,class:"f-0",columns:le.value,allColumns:l.value,btns:re.value,isEmpty:!(null==(s=te.value)?void 0:s.length),"onUpdate:cols":t[1]||(t[1]=e=>{le.value=e}),onClick:fe,total:Z.total,batchBtn:e.batchBtn&&e.selection,size:e.size,ref_key:"extraBtnsRef",ref:A},null,8,["columns","allColumns","btns","isEmpty","total","batchBtn","size"])):U("",!0),E(e.$slots,"default",{loading:ee.value,rows:te.value,total:Z.total,hasMore:Z.hasMore,params:D(ae),onGroupBtn:_e},(()=>[q(a,k({groupBtnsAttrs:{compact:e.compact,small:"small"===e.size,...e.groupBtnsAttrs},loading:ee.value,cols:le.value,rows:te.value,total:Z.total,sort:!!e.sort,index:e.index,selection:ie.value,groupBtns:e.groupBtns,currPage:e.pagination?Y[D(T).curr_page]:1,pageSize:e.pagination?Y[D(T).page_size]:20,filterBtnsByAuth:ve,refreshList:he,onGroupBtn:_e,onSelectionChange:je,"onUpdate:cols":t[2]||(t[2]=e=>{l.value=e}),disabled:e.disabled},e.tableAttrs,{size:e.size,ref_key:"queryTableRef",ref:y}),{custom:L((({row:t,col:s,$index:o})=>[E(e.$slots,s.prop,Q(G({row:t,col:s,$index:o})),void 0,!0)])),_:3},16,["groupBtnsAttrs","loading","cols","rows","total","sort","index","selection","groupBtns","currPage","pageSize","disabled","size"])]),!0),e.pagination&&e.showPagination?(R(),V(b,k({key:1},e.pageAttrs,{currPage:Y[D(T).curr_page],"onUpdate:currPage":t[3]||(t[3]=e=>Y[D(T).curr_page]=e),pageSize:Y[D(T).page_size],"onUpdate:pageSize":t[4]||(t[4]=e=>Y[D(T).page_size]=e),total:Z.total,onSizeChange:ce,onCurrentChange:me,small:"small"===e.size}),null,16,["currPage","pageSize","total","small"])):U("",!0)],512)}}}),[["__scopeId","data-v-6c36c3e0"]]);export{K as default};
